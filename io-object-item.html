<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../io-value/io-value.html">
<link rel="import" href="../io-input/io-input.html">

<!--
`<io-object-item>` is used by `<io-object>` element to display element key-value pairs.

TODO: WORK IN PROGRESS

@demo demo/index.html Basic Demo
-->

<dom-module id="io-object-item">
  <style>
    :host {
      display: block;
      white-space: nowrap;
    }
    .io-key {
      vertical-align: top;
      color: rgb(140, 13, 150);
      cursor: pointer;
    }
    .io-key:after {
      content: ':';
      float: right;
    }
    io-value {
      display: inline;
      vertical-align: top;
    }
    io-value::shadow > io-input:not(:empty) {
      color: rgb(198, 22, 5);
    }
    io-value::shadow > io-boolean,
    io-value::shadow > io-input {
      color: rgb(25, 0, 211);
    }
  </style>
  <template>
    <template is="dom-if" if="{{_isarray}}">
      <io-input class="io-key"
          type="integer"
          on-io-value-set="_keySet"
          value="{{key}}"
          aria-label="index"
          disabled="{{disabled}}"></io-input>
    </template>
    <template is="dom-if" if="{{!_isarray}}">
      <io-input class="io-key"
          type="string"
          on-io-value-set="_keySet"
          value="{{key}}"
          aria-label="key"
          disabled="{{disabled}}"></io-input>
    </template>
    <io-value id="value"
        on-io-value-set="_valueSet"
        value="{{value}}"
        disabled="{{disabled}}"></io-value>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'io-object-item',
    properties: {
      object: {
        value: null,
        notify: true,
        type: Array,
        observer: '_objectChanged'
      },
      value: {
        value: null
        // notify: true,
        // observer: '_valueChanged'
      },
      key: {
        value: null,
        // notify: true,
        type: String,
        // observer: '_keyChanged',
      },
      disabled: {
        value: false,
        type: Boolean,
      },
      //
      _isarray: {
        value: false,
        type: Boolean,
      },
      // valueeditor: {
      //   value: null,
      //   type: HTMLElement
      // },
      // keyeditor: {
      //   value: null,
      //   type: HTMLElement
      // }
    },
    hostAttributes: {
      role: 'treeitem'
    },
    // listeners: {
    //   'keydown': '_onKeydown',
    //   'io-object-item-select': '_onIoObjectItemSelect'
    // },
    // _onKeydown: function(event) {
      // event.stopPropagation();
      // var nextKey = this.nextElementSibling ? this.nextElementSibling.keyeditor : null;
      // var nextValue = this.nextElementSibling ? this.nextElementSibling.valueeditor : null;
      // var prevKey = this.previousElementSibling ? this.previousElementSibling.keyeditor : null;
      // var prevValue = this.previousElementSibling ? this.previousElementSibling.valueeditor : null;
      // // TODO: handle object expander focus
      // var selection = window.getSelection();
      // var textLength = String(event.path[0].textContent).length;
      // var atStart = selection.baseOffset === 0;
      // var atEnd = selection.baseOffset === textLength;
      // // TODO: yuck
      // var isToggable = event.path[0].localName.search('boolean') != -1 || event.path[0].localName === 'io-function';
      // var isKey = event.path[0].classList.contains('io-key');
      // if (selection.isCollapsed) {
      //   // left
      //   if (event.which === 37 && (atStart || isToggable)) {
      //     event.preventDefault();
      //     if (!isKey) {
      //       this.keyeditor.focus();
      //     } else if (prevValue) {
      //       prevValue.focus();
      //     } else {
      //       this.fire('io-object-item-select');
      //     }
      //   // right
      //   } else if (event.which === 39 && (atEnd || isToggable)) {
      //     event.preventDefault();
      //     if (isKey) {
      //       this.valueeditor.focus();
      //     } else if (nextKey) {
      //       nextKey.focus();
      //     } else {
      //       this.fire('io-object-item-select');
      //     }
      //   // up
      //   } else if (event.which === 38 && (atStart || isToggable)) {
      //     event.preventDefault();
      //     if (isKey && prevKey) {
      //       prevKey.focus();
      //     } else if (!isKey && prevValue) {
      //       prevValue.focus();
      //     } else if (!isKey) {
      //       this.keyeditor.focus();
      //     } else {
      //       this.fire('io-object-item-select');
      //     }
      //   // down
      //   } else if (event.which === 40 && (atEnd || isToggable)) {
      //     event.preventDefault();
      //     if (isKey && nextKey) {
      //       nextKey.focus();
      //     } else if (!isKey && nextValue) {
      //       nextValue.focus();
      //     } else if (isKey) {
      //       this.valueeditor.focus();
      //     } else {
      //       this.fire('io-object-item-select');
      //     }
      //   } else if (event.which === 13 && !isToggable) {
      //     event.preventDefault();
      //     if (isKey) {
      //       this.valueeditor.focus();
      //     } else if (this.key !== null) {
      //       this.fire('io-object-add-item-after', {key: this.key});
      //     }
      //   }
      // }
    // },
    // _onIoObjectItemSelect: function(event) {
    //   if (event.path[0] !== this) {
    //     event.stopPropagation();
    //     this.keyeditor.focus();
    //   }
    // },
    _valueSet: function(event) {
      this.object[this.key] = this.value;
    },
    _keySet: function(event) {
      // TODO: remove keys properly
      event.stopPropagation(); //?
      // TODO: handle arrays
      if (this._isarray) {
        this.object.splice(Number(event.detail.oldValue), 1);
        if (event.detail.value !== null && event.detail.value !== undefined) {
          this.object.length = Math.max(this.object.length, event.detail.value);
          this.object.splice(event.detail.value, 0, this.value);
        }
      } else {
        // TODO: test
        delete this.object[event.detail.oldValue];
        if (event.detail.value !== '' && event.detail.value !== null && event.detail.value !== undefined) {
          this.object[String(event.detail.value)] = this.value;
        }
      }
      // TODO: handle focus
    },
    // _valueChanged: function() {
    //   this.async(function() {
    //     this.valueeditor = this.$$('#value')._editor;
    //   }.bind(this));
    // },
    // _keyChanged: function() {
    //   this.async(function() {
    //     this.keyeditor = this.$$('.io-key');
    //   }.bind(this));
    // },
    _objectChanged: function() {
      this._isarray = this.object instanceof Array;
    }
  });
</script>
