<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../io-value/io-styles.html">
<link rel="import" href="io-object-item.html">

<!--
`io-object` is a simple editor for javascript objects.

By default, it uses `io-value` element for string, number and boolean properties.

The element can be configured to use any elements for property values.

Example:

    <io-object></io-object>

@IoElement
@extends Polymer.Element
@summary `io-object` is a simple editor for javascript objects.
@demo demo/ io-object demo
-->

<dom-module id="io-object">
  <template>
    <style is="custom-style" include="io-styles">
    .io-constructor {
      cursor: pointer;
      color: var(--io-color-constructor);
    }
    :host(:not([labeled])) .io-label {
      display: none;
    }
    .io-label {
      color: var(--io-color-label);
      vertical-align: top;
      user-select: none;
    }
    .io-label:before {
      content: "\A";
      white-space: pre;
    }
    </style>
    <span class="io-constructor"
      on-click="_toggleHandler"
      on-keydown="_toggleHandler"
      tabindex="0">[[_constructor]]</span>
    <template is="dom-repeat" items="{{_keys}}">
      <span class="io-label">[[item]]</span>: <io-object-item key="[[item]]" value="[[value]]"></io-object-item>
    </template>
  </template>
  <script>

  class IoObject extends Polymer.Element {
    static get is() { return 'io-object'; }
    static get properties() {
     return {
       /* Value (object) to be edited with this element. */
       value: {
         type: Object,
         observer: '_updateJob'
       },
       /* This attribute expands property editors. */
       expanded: {
         value: false,
         type: Boolean,
         observer: '_updateJob',
         reflectToAttribute: true
       },
       /* This attribute reveals property labels. */
       labeled: {
         value: false,
         type: Boolean,
         observer: '_updateJob',
         reflectToAttribute: true
       },
       _keys: {
         value: null,
         type: Array,
         notify: true
       }
     }
    }
    _toggleHandler(event) {
      if (event.which == 13 || event.which == 32) {
        event.preventDefault();
        this.expanded = !this.expanded;
      } else if (event.type == 'click') {
        this.expanded = !this.expanded;
      }
    }
    _update() {
      if (typeof this.value == 'object' && this.value !== null) {
        if (this.expanded) {
          this._constructor = '▾ ' + this.value.constructor.name || 'Object';
          this._keys = Object.keys(this.value);
        } else {
          this._constructor = '▸ ' + this.value.constructor.name || 'Object';
          this._constructor += '(' + Object.keys(this.value).length + ')';
          this._keys = [];
        }
      }
    }
    _updateJob() {
      clearTimeout(this._updateID);
      this._updateID = setTimeout(() => {
        delete this._updateID;
        this._update();
      });
      if (this.hasAttribute('demo') && !this.value) {
        this.value = {
          number: 1337,
          string: 'hello',
          boolean: true,
          null: null,
          NaN: NaN,
          undefined: undefined,
          array: [1, 2, 3, 4]
        }
        this.value.object = this.value;
      }
    }
  }

  window.customElements.define(IoObject.is, IoObject);

  </script>
</dom-module>
