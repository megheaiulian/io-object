<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-list/iron-list.html">
<link rel="import" href="../io-object-to-array/io-object-to-array.html">
<link rel="import" href="../io-boolean/io-boolean.html">
<link rel="import" href="io-object-item.html">
<!--
`<io-object>` is a custom HTML element that can be used an editor for object/array values.

Example:

    <io-object
        value="{{objectvalue}}">
    </io-object>

@demo demo/index.html Basic Demo
-->
<dom-module id="io-object">
  <style>
    :host {
      display: inline-block;
    }
    #constructor {
      cursor: pointer;
      white-space: nowrap;
    }
    #name {
      font-style: italic;
    }
    #length::before {
      content: '[';
    }
    #length::after {
      content: ']';
    }
    #properties {
      margin-left: 0.5em;
    }
  </style>
  <template>
    <span id="constructor">
      <io-boolean icon id="expandicon" on-io-value-set="_onExandedSet" tabindex="-1" value="{{expanded}}" trueicon="expand-more" falseicon="chevron-right"></io-boolean>
      <span id="name">{{value.constructor.name}}</span>
      <span id="length">{{_valuearray.length}}</span>
    </span>
    <template is="dom-if" if="{{expanded}}">
      <div id="properties">
        <template is="dom-repeat" id="repeat" items="{{_valuearray}}">
          <io-object-item
              value="{{item.value}}"
              key="{{item.key}}"
              disabled="{{disabled}}"
              on-add-item-after="_onAddItemAfter">
          </io-object-item>
        </template>
      </div>
    </template>
  </template>
</dom-module>

<script>
(function() {
  var i, observedkeys, keys;
  Polymer({
    is: 'io-object',
    properties: {
      /**
       * Object value
       */
      value: {
        value: null
      },
      /**
       * Desables the element.
       */
      disabled: {
        type: Boolean
      },
      /**
       * Determines if the editor is expanded
       */
      expanded: {
        value: false,
        type: Boolean,
        observer: '_expandedChangedJob'
      },
      _valuearray: {
        computed: 'computeObservedMapArray(value, "_valuearray")'
      }
    },
    behaviors: [
      Polymer.ioObjectToArray
    ],
    hostAttributes: {
      oncontextmenu: 'return false;',
      role: 'tree'
    },
    _onExandedSet: function() {
      if (this.expanded) {
        this.async(function () {
          // var item = this.$$('io-object-item');
          // item.$$('.io-key').focus();
        }.bind(this), 1);
      }
    },
    _isArray: function (value) {
      return value instanceof Array;
    },
    focus: function() {
      this.$.expandicon.focus();
    },
    // _onAddItemAfter: function(event) {
    //   if (this.value instanceof Array) {
    //     this.splice('_observedkeys', Number(event.detail.index + 1), 0, {key: Number(event.detail.index + 1), value: null});
    //     for(var i = 0; i < this._observedkeys.length; i++) {
    //       this._observedkeys[i].key = i;
    //     }
    //     // TODO: dont focus if extended by application.
    //     this.async(function () {
    //       var items = this.querySelectorAll('io-object-item');
    //       items[Number(event.detail.index + 1)].$$('.io-key').focus()
    //     }.bind(this), 1);
    //   } else {
    //     this.splice('_observedkeys', this._observedkeys.length, 0, {key: null, value: null});
    //     this.async(function () {
    //       var items = this.querySelectorAll('io-object-item');
    //       items[items.length - 1].key = '__newKey';
    //       items[items.length - 1].$$('.io-key').$.input.value = '';
    //       items[items.length - 1].$$('.io-key')._updateInputWidth();
    //       // items[items.length - 1].$$('.io-key').immediatevalue = '';
    //       items[items.length - 1].$$('.io-key').focus();
    //     }.bind(this), 1);
    //   }
    //   this.notifyPath("_observedkeys", this._observedkeys.slice());
    // },
    _expandedChanged: function() {
      if (this.expanded) {
        if (this._valuearray.length === 0) {
          // Add empty item if no items are present.
          // this._onAddItemAfter({detail: {index: -1}});
        }
      } else {
      //
      }
      if (this.expanded) {
        this.setAttribute('aria-expanded', '');
      } else {
        this.removeAttribute('aria-expanded');
      }
    },
    _expandedChangedJob: function () {
      this.debounce('io-object-expanded-changed', this._expandedChanged, 1);
    }
  });
}());
</script>
