<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../observe-js/observe-js.html">
<link rel="import" href="../iron-list/iron-list.html">
<link rel="import" href="../io-boolean/io-boolean.html">
<link rel="import" href="io-object-item.html">
<!--
`<io-object>` is a custom HTML element that can be used an editor for object/array values.

Example:

    <io-object
        value="{{objectvalue}}">
    </io-object>

TODO: WORK IN PROGRESS

@demo demo/index.html Basic Demo
-->
<dom-module id="io-object">
  <style>
    #constructor {
      cursor: pointer;
      white-space: nowrap;
    }
    #name {
      font-style: italic;
    }
    #length::before {
      content: '[';
    }
    #length::after {
      content: ']';
    }
    #expandicon:focus {
      background: transparent;
      box-shadow: none;
     }
    #properties {
      /* TODO: test with fixed height and iron-list */
      /*overflow-x: hidden;*/
      /*overflow-y: auto;*/ 
      margin-left: 1em;
    }
  </style>
  <template>
    <span id="constructor">
      <io-boolean icon id="expandicon" tabindex="-1" value="{{expanded}}" trueicon="expand-more" falseicon="chevron-right"></io-boolean>
      <span on-tap="toggleExpanded">
        <span id="name">{{value.constructor.name}}</span>
        <span id="length">{{_observedkeys.length}}</span>
      </span>
    </span>
    <template is="dom-if" if="{{expanded}}">
      <div id="properties"><!-- flex?="{{corelist}}" -->
        <template is="dom-repeat" items="{{_observedkeys}}">
          <io-object-item
              object="{{value}}"
              value="{{item.value}}"
              key="{{item.key}}"
              disabled="{{disabled}}">
          </io-object-item>
        </template>
      </div>
    </template>
  </template>
</dom-module>

<script>
(function() {
  var i, observedkeys, keys;
  Polymer({
    is: 'io-object',
    properties: {
      /**
       * Object value
       */
      value: {
        notify: true,
        observer: '_valueChanged'
      },
      /**
       * Determines if the input can be focused and edited by user action.
       */
      disabled: {
        value: false,
        type: Boolean
      },
      /**
       * Determines if the editor is expanded
       */
      expanded: {
        value: false,
        notify: true,
        type: Boolean,
        observer: '_expandedChanged'
      },
      // corelist: {
      //   value: false,
      //   type: Boolean
      // },
      _observedkeys: {
        value: null,
        type: Array
      }
    },
    hostAttributes: {
      oncontextmenu: 'return false;',
      role: 'tree'
    },
    // listeners: {
    //   'io-object-add-item-after': '_onAddItemAfter'
    // },
    toggleExpanded: function() {
      this.expanded = !this.expanded;
    },
    focus: function() {
      this.$.expandicon.focus();
    },
    // _onAddItemAfter: function(event) {
    //   event.stopPropagation();
    //   observedkeys = [];
    //   for (i = 0; i < this._observedkeys.length; i++) {
    //     observedkeys.push(this._observedkeys[i]);
    //     if (this._observedkeys[i].key === event.detail.key) {
    //       observedkeys.push({
    //         key: null, value: null
    //       });
    //     }
    //   }
    //   // TODO: does not work on non-chrome
    //   this._observedkeys = observedkeys;
    //   requestAnimationFrame(function() {
    //     var item = this.$$('io-object-item[key="' + event.detail.key + '"]');
    //     item.nextElementSibling.keyeditor.focus();
    //   }.bind(this));
    // },
    _expandedChanged: function() {
      // if (this.expanded && this._observedkeys && this._observedkeys.length === 0) {
      //   this._observedkeys = [{key: null, value: null}];
      // }
      if (this.expanded) {
        this.setAttribute('aria-expanded', '');
      } else {
        this.removeAttribute('aria-expanded');
      }
    },
    _valueChanged: function(value, oldValue) {
      //TODO: smarted observe
      this._observedkeys = [];
      if (!this.value || typeof this.value !== 'object') return;
      this.__updateKeys = this._updateKeys.bind(this);
      this.__updateKeys();

      if (this.__observer) this.__observer.close();
      this.__observer = new ObjectObserver(this.value);
      this.__observer.open(function() {
        this.__updateKeys();
      }.bind(this));
    },
    _updateKeys: function() {
      observedkeys = [];
      if (this.value instanceof Array) {
        for (i = 0; i < this.value.length; i++) {
          observedkeys.push({key: i, value: this.value[i]});
        }
      } else {
        keys = Object.keys(this.value);
        for (i in keys) {
          observedkeys.push({key: keys[i], value: this.value[keys[i]]});
        }
      }
      this._observedkeys = observedkeys;
    }
  });
}());
</script>
